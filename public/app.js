const CATEGORIES = [
  "Все",
  "Терроризм",
  "Физическая",
  "Экология",
  "Энергетика",
  "Инфобез",
  "Психология",
  "Техногенная",
  "Пожарная",
  "Экономическая",
  "Интеллектуальная",
];

const CATEGORY_HINT = {
  Терроризм: "Диверсии, захват персонала, координированные атаки на объекты",
  Физическая: "Несанкционированное проникновение, кражи оборудования, обход охраны",
  Экология: "Разливы, выбросы, вмешательство в экомониторинг и отчётность",
  Энергетика: "Сбои электроснабжения, РЗА, ИБП, телемеханика и энергобаланс",
  Инфобез: "Кибератаки, компрометация данных, фишинг, шифровальщики",
  Психология: "Давление на сотрудников, выгорание, социальная инженерия",
  Техногенная: "Аварии оборудования, нарушения регламентов, разгерметизация",
  Пожарная: "Пожарные риски, АПС/АУПТ, возгорания и статическое электричество",
  Экономическая: "Манипуляции расчётами, рынками, цепочками поставок",
  Интеллектуальная: "Хищение R&D, геоданных, проектной документации и патентов",
  Общее: "Общая информационная угроза без точного отнесения",
};

const CATEGORY_KEYWORDS = {
  Терроризм: [
    "теракт",
    "террор",
    "диверс",
    "радикал",
    "боевик",
    "взрывное устройство",
    "заложник",
    "экстремист",
    "подрыв",
    "группировк",
    "саботаж",
    "заложников",
    "бомба",
    "обстрел",
    "дроны",
    "теракты",
  ],
  Физическая: [
    "проникновен",
    "несанкционирован",
    "скуд",
    "вскрыли",
    "охран",
    "кража оборуд",
    "кража",
    "воров",
    "захват",
    "охрана",
    "серверн",
    "кроссов",
    "пломб",
    "кабельн",
    "видеонаблюд",
    "физич",
    "цод",
    "стойк",
    "обход охраны",
    "инвентаризац",
  ],
  Экология: [
    "эколог",
    "разлив",
    "пролив",
    "загрязн",
    "выброс",
    "пдк",
    "сток",
    "сероводород",
    "утечка неф",
    "мониторинг среды",
    "отход",
    "эмисси",
    "шлам",
    "водоем",
    "река",
    "озеро",
  ],
  Энергетика: [
    "подстанц",
    "энергос",
    "энергоснаб",
    "электроснаб",
    "рза",
    "ибп",
    "дгу",
    "блэкаут",
    "фидер",
    "энергобаланс",
    "грщ",
    "распределит",
    "генерац",
    "энергоблок",
    "отключение света",
    "энергообъект",
    "энергетичес",
  ],
  Инфобез: [
    "кибератак",
    "хак",
    "взлом",
    "ddos",
    "вредонос",
    "ransom",
    "malware",
    "apt",
    "фишинг",
    "утечк",
    "компрометац",
    "scada",
    "ics",
    "асу тп",
    "учетн",
    "vpn",
    "учетные записи",
    "данные сотрудников",
  ],
  Психология: [
    "выгорание",
    "усталость",
    "давление",
    "шантаж",
    "мотивац",
    "лояльн",
    "конфликт",
    "забастов",
    "кадров",
    "эмоциональ",
    "вербовк",
    "дезинформац",
  ],
  Техногенная: [
    "авария",
    "техноген",
    "утечка газа",
    "разгермет",
    "отказ оборуд",
    "сбой оборуд",
    "гидрат",
    "корроз",
    "турбин",
    "разрушение",
    "обрушение",
    "авария нпз",
    "авария скважин",
  ],
  Пожарная: [
    "пожар",
    "возгора",
    "огне",
    "искра",
    "статическ",
    "плам",
    "апс",
    "аупт",
    "дым",
    "эвакуац",
    "огневые работы",
  ],
  Экономическая: [
    "финанс",
    "эконом",
    "бирж",
    "рынок",
    "платеж",
    "кредит",
    "мошен",
    "вымогатель",
    "контрагент",
    "транзак",
    "логист",
    "поставк",
    "закуп",
    "отчетност",
  ],
  Интеллектуальная: [
    "патент",
    "ноу-хау",
    "геодан",
    "r&d",
    "рецептур",
    "проектн",
    "чертеж",
    "инженерн",
    "секретн",
    "цифровой двойник",
    "seismic",
    "petrel",
    "геологическ",
  ],
};

const OIL_GAS_TERMS = [
  "нефтегаз",
  "нефть",
  "нефтя",
  "газ",
  "газов",
  "lng",
  "спг",
  "буров",
  "бурени",
  "скважин",
  "скважина",
  "газопровод",
  "трубопровод",
  "нефтепровод",
  "нпз",
  "нефтепереработ",
  "нефтехим",
  "месторожден",
  "платформа",
  "углеводород",
  "нефтепродукт",
  "бензин",
  "добыча",
  "отгрузка нефти",
  "газпром",
  "rosneft",
  "роснефть",
  "лукойл",
  "татнефть",
  "gazprom",
  "gpn",
  "refinery",
  "pipeline",
  "oil",
  "petro",
  "petroleum",
];

const ENERGY_TERMS = [
  "энергетика",
  "энергос",
  "энергоснаб",
  "электроснаб",
  "подстанц",
  "рза",
  "ибп",
  "дгу",
  "кабели 6",
  "кабели 10",
  "линии электропередач",
  "фидер",
  "грэч",
  "грщ",
  "asdu",
  "рзу",
  "подстанция",
  "энергоузел",
  "энергетичес",
  "теплоснаб",
  "электроэнерг",
  "энергохозяйств",
  "диспетчерск",
  "тэц",
  "гэc",
  "эс",
  "гэс",
  "тсс",
  "энергообъект",
  "энергоблок",
  "отключение света",
  "блэкаут",
];

const PERIODS = {
  "7d": { label: "7 дней", ms: 7 * 24 * 60 * 60 * 1000 },
  "30d": { label: "30 дней", ms: 30 * 24 * 60 * 60 * 1000 },
  "90d": { label: "90 дней", ms: 90 * 24 * 60 * 60 * 1000 },
  "1y": { label: "1 год", ms: 365 * 24 * 60 * 60 * 1000 },
};

const MAX_FEED = 400;
const THREAT_TEXT = `
Несанкционированное физическое проникновение в серверные помещения через обход охраны (включая использование поддельных пропусков, вскрытие дверей или поставку сотрудника внешними злоумышленниками).
Кража серверного и сетевого оборудования (серверы, СХД, коммутаторы, маршрутизаторы) с целью извлечения носителей информации или вывоза компонентов, критичных для функционирования систем.
Подмена или несанкционированная установка оборудования (замена сетевого компонента или контроллера на заражённый/компрометированный аналог) во время обслуживания или транспортировки.
Несанкционированное подключение внешних периферийных устройств (USB-накопителей, переносных компьютеров, мобильных телефонов) к рабочим станциям и промышленным контроллерам, приводящее к компрометации данных или внедрению вредоносного ПО.
Несанкционированный доступ к стойкам с серверным оборудованием в дата-центрах филиалов из-за отсутствия должного запирания, контроля и журналирования посещений.
Подмена или кража сменных накопителей и резервных носителей при их перемещении между объектами или в ходе выездного обслуживания без строгой цепочки хранения.
Несанкционированное фотографирование или видеосъёмка помещений с вычислительной аппаратурой и коммутацией, с последующей передачей изображений третьим лицам, позволяющее спланировать физические атаки.
Помещение оборудования (серверов, коммутаторов, контроллеров) в доступные для посетителей зоны или временные площадки без защиты, что позволяет посторонним лицам получить прямой физический доступ.
Неправомерные действия обслуживающего персонала третьих организаций (несанкционированная инвентаризация, скрытая установка ПО на оборудование в ходе ремонта или замены узлов).
Нарушение контроля за выдачей и использованием ключей, карт доступа и средств аутентификации персонала, что позволяет утерянным или похищенным средствам доступа использоваться злоумышленниками.
Оставление незашифрованных резервных копий и носителей с конфиденциальной информацией в местах общего доступа или в авто транспорта при транспортировке между объектами.
Физическое вмешательство в кабельные трассы и сетевые шкафы сотрудниками или подрядчиками без оформления разрешений, приводящее к нарушению связи и отказам систем мониторинга.
Установка несертифицированных или неподтверждённых защитных корпусов и модулей в стойки оборудования, препятствующих надлежащему охлаждению и приводящих к отказам техники.
Несанкционированное размещение вычислительных узлов или средств хранения вне контролируемых ЦОД (в кабинетах персонала, смежных помещениях) без резервирования и контроля.
Несоблюдение правил маркировки и пломбирования интерфейсов портов и разъёмов в критических системах, что облегчает несанкционированные подключения и утечки информации.
Неправильное хранение и утилизация устаревших накопителей и комплектующих без предварительного удаления или физического разрушения данных.
Проникновение посторонних лиц в помещения операторов и диспетчерских пунктов под видом посетителей, курьеров, подрядчиков с последующим доступом к терминалам и мониторам.
Размещение вспомогательного оборудования (портативных точек доступа, маршрутизаторов) сотрудниками без согласования, создающее неучтённые радиосети и уязвимости для физического вмешательства.
Ошибка при замене кабельных подключений в стойках (перепутанные порты, неплотные соединения) персоналом, приводящая к деградации сети и отказам сервисов.
Недостаточный контроль над временными рабочими зонами (временные щиты, строительные площадки) рядом с коммуникационными узлами, что даёт возможность посторонним получить физический доступ к линиям и оборудованию.
Проникновение через технические подземные или подвальные коммуникации к кроссовым шкафам и распределительным щитам с целью перерезания/переподключения кабелей.
Неавторизованное использование портов сервисного доступа к промышленным контроллерам (серийные порты, JTAG, консольные порты) внутри помещений эксплуатации.
Наличие незарегистрированных или устаревших рабочих станций, подключённых физически к производственной сети, доступных для физического вмешательства на площадках.
Нарушение целостности корпуса и пломбировки серверных шкафов вследствие несанкционированного вскрытия техническими специалистами или злоумышленниками.
Подключение посторонних устройств к линиям промышленной автоматики (например, внедрение модулей диагностики без контроля) с физическим вмешательством в управление объектом.
Попытки несанкционированного использования мобильных терминалов и планшетов персонала для доступа к системам управления при отсутствии физической блокировки портов и опций удалённого контроля.
Умышленное повреждение или манипуляция с пломбами и индикаторами вскрытия на критических узлах, что позволяет скрыть последующие несанкционированные подключения.
Нарушение процедур допуска и контроля для подрядчиков и субподрядчиков, в том числе несвоевременная проверка документов и отсутствие сопровождения при работах вблизи оборудования.
Умышленное блокирование доступа легитимного персонала к помещениям с вычислительной техникой (закрытие дверей, блокировка СКУД), приводящее к невозможности управления и обслуживания.
Неправильное или несанкционированное подключение резервных физических носителей в процессе аварийного восстановления, когда внешние носители содержат неподтверждённые образцы ПО.
Несоблюдение требований по физическому разделению сетей (отсутствие зонализации), когда рабочие и гости имеют физический доступ к общим стойкам и коммутациям.
Неавторизованное использование внешних коммуникационных устройств (портативные модемы, радиоточки) сотрудниками в помещениях с критическими системами, создающее физическую уязвимость каналов.
Манипуляция данными коммерческого учета нефти и газа на узлах учета
Крипто-вымогательская атака на АСУ ТП добычи/переработки
Целевой саботаж SCADA-систем.
Подмена данных в системах планирования и диспетчеризации (ERP, MES)
Кража данных для фишинговых атак на финансовый департамент
Манипуляция данными в системах управления закупками
Атака на систему управления кредитными рисками
Срыв операций на товарно-сырьевых биржах (DDoS)
Подмена данных при сдаче государственной отчетности (в ФНС, Роснедра)
Срыв сеансов связи с системами ГИС ТЭК
Атака на системы расчета с контрагентами
Кража информации о размере и сроках крупных денежных транзакций
Саботаж системы управления ППР (планово-предупредительными ремонтами)
Манипуляция данными систем экологического мониторинга
Атака на систему бронирования мощностей магистральных трубопроводов
Фальсификация данных о качестве продукции
Манипуляции с данными о добыче для уклонения от налогов
Фальсификация данных таможенных деклараций
Блокировка платежных систем
Срыв сроков поставок путем вмешательства в логистические системы
Перехват коммерческой тайны (себестоимость, поставщики, логистика)
Целевая APT-атака на всю цепочку создания стоимости
Крипто-вымогательство с угрозой публикации украденной ИС
Кража базы данных сотрудников
Разгерметизация аппаратов, емкостей и трубопроводов, содержащих горючие газы (ГГ) и легковоспламеняющиеся жидкости (ЛВЖ)
Выход из строя средств контроля и автоматики (датчики давления, температуры, уровня), приводящий к выходу технологических параметров за критические пределы.
Отказ систем блокировки и отсечной арматуры, предназначенных для локализации аварии.
Нарушение установленного порядка проведения огневых работ (сварка, резка).
Самовозгорание пирофорных отложений (например, сернистых соединений железа) в аппаратах и оборудовании.
Возникновение разрядов статического электричества при транспортировке диэлектрических жидкостей и пылей и недостаточность мер по его отводу.
Перегрев подшипниковых узлов насосного или компрессорного оборудования с воспламенением смазочных материалов.
Нарушение технологии продувки и освобождения технологических систем от горючих сред.
Использование неисправного или несертифицированного электрооборудования во взрывопожароопасных зонах.
Неисправность или отключение автоматической пожарной сигнализации (АПС), приводящее к несвоевременному обнаружению пожара.
Отказ или нерасчетная работа автоматической установки пожаротушения (АУПТ).
Недостаточная эффективность или отказ системы противодымной защиты, приводящая к задымлению путей эвакуации.
Неисправность или отсутствие системы аварийной вентиляции в помещении с ГГ и ЛВЖ.
Снижение проектной огнестойкости строительных конструкций (например, из-за повреждения огнезащитного покрытия).
Неисправность огнезадерживающих клапанов в вентиляционных системах.
Несоответствие первичных средств пожаротушения (огнетушителей) по типу, количеству и расположению.
Неисправность внутреннего противопожарного водопровода (ВПВ) или недостаточное давление в нем.
Загромождение или отсутствие подъездов к источникам наружного противопожарного водоснабжения (пожарным гидрантам, водоемам).
Отсутствие или неисправность молниезащиты зданий и сооружений.
Нарушение противопожарных разрывов между технологическими установками, зданиями и складами.
Загромождение эвакуационных путей и выходов оборудованием, материалами или мусором.
Неисправность аварийного освещения на путях эвакуации.
Отсутствие или нечитаемость знаков пожарной безопасности, включая эвакуационные знаки и знаки для размещения огнетушителей.
Несанкционированное хранение легковоспламеняющихся материалов и горючей тары в производственных зонах.
Нарушение правил совместного хранения веществ и материалов, способных к взаимодействию с воспламенением.
Несвоевременная уборка горючих отходов, пыли и проливов нефтепродуктов на территории и в помещениях.
Несоблюдение требований к противопожарным преградам (двери, люки, клапаны) — их отсутствие, неисправность или незакрытие.
Нарушение технологического регламента и инструкций по эксплуатации (превышение давления, температуры, уровня в аппаратах).
Курение в неустановленных местах, особенно в зонах с возможным выделением ГГ.
Недостаточное обучение персонала мерам пожарной безопасности, неотработанные действия при пожаре.
Несвоевременное проведение технического обслуживания и проверок работоспособности систем противопожарной защиты.
Проезд и стоянка транспорта вне установленных мест, создающая помехи для подъезда пожарной техники.
Неправильное наложение и несвоевременное снятие перенапряжений на оборудовании (например, при ремонте), приводящее к искрообразованию.
Отсутствие или несоответствие инструкции о мерах пожарной безопасности для конкретных помещений и производств.
Несвоевременная разработка и корректировка планов ликвидации аварийных разливов нефти (ЛАРН), что усугубляет пожарную опасность при разливе.
Несанкционированный доступ к информации через Интернет
Несанкционированный доступ к информации через использование учетных записей
Утечка информации по техническим каналам
Перехват информации, передаваемой по каналам связи
Несанкционированный доступ с использованием вредоносных программ
Утечка информации через устройства печати
Утечка информации через внешние запоминающие устройства
Утечка информации через мобильные устройства связи
Утечка информации при использовании облачных сервисов
Нарушение функционирования информационной системы из-за несанкционированного воздействия
Нарушение работоспособности системы из-за программно-аппаратных сбоев
Нарушение работоспособности системы из-за сбоев в электропитании
Нарушение работоспособности системы из-за ошибок проектирования
Нарушение работоспособности системы из-за низкого качества техобслуживания
Нарушение работоспособности системы из-за старения технических средств
Нарушение работоспособности системы из-за воздействия внешней среды.
Отказ в обслуживании (DoS-атаки)
Блокирование информации программой-вымогателем
Нарушение доступности информации из-за неработоспособности системы резервного копирования
Нарушение доступности информации из-за изменения маршрутов
Нарушение технологических процессов из-за несанкционированного доступа к АСУ ТП
Нарушение функционирования АСУ ТП из-за внедрения вредоносных программ
Нарушение функционирования АСУ ТП из-за воздействия через каналы связи
Нарушение функционирования АСУ ТП из-за изменения программного обеспечения
Нарушение функционирования АСУ ТП из-за изменения настроек.
Нарушение безопасности информации при использовании несертифицированных средств защиты
Нарушение безопасности информации из-за непроектных режимов эксплуатации
Разглашение конфиденциальной информации сотрудниками по неосторожности
Установка неавторизованного ПО, приводящая к компрометации систем
Переход по фишинговым ссылкам в корпоративной почте
Использование простых паролей для доступа к критическим системам
Несоблюдение регламентов при работе с удаленным доступом
Нарушение правил обработки конфиденциальных данных
Невыполнение требований по резервному копированию
Несвоевременное обновление ПО и средств защиты
Использование личных устройств для рабочих задач
Несообщение о подозрительных событиях в системе
Передача учетных данных третьим лицам
Работа с конфиденциальной информацией в публичных местах
Профессиональное выгорание оперативного персонала
Хроническая усталость у сотрудников на объектах с вахтовым методом работы
Низкая мотивация и лояльность ключевых специалистов
Психологическое давление на сотрудников со стороны руководства
Эмоциональная нестабильность сотрудника, допущенного к управлению КВО
Неврозы и тревожные расстройства у персонала в условиях повышенной ответственности
Склонность персонала к риску и игнорированию регламентов
Алкогольная или наркотическая зависимость сотрудника на рабочем месте
Целевые фишинговые рассылки, маскирующиеся под распоряжения руководства
Целенаправленная дезинформация в СМИ и соцсетях о компании
Вербовка сотрудников спецслужбами иностранных государств
Психологическое давление (шантаж, угрозы семье) на сотрудников.
Распространение через корпоративные каналы материалов экстремистского содержания.
Информационные кампании по дискредитации руководства компании.
Создание фейковых профсоюзных движений для организации забастовок.
Психологическая обработка сотрудников для участия в несанкционированных митингах.
Использование социальных сетей для изучения «слабых мест» сотрудников.
Распространение слухов о предстоящем банкротстве или массовых увольнениях.
Культура замалчивания ошибок.
Недостаточное обучение и психологическая подготовка к действиям в ЧС.
Неэффективная система информирования сотрудников.
Конфликт между разными подразделениями
Отсутствие системы психологической поддержки и помощи сотрудникам
Непроведение регулярного психологического тестирования для сотрудников с допуском
Несправедливая система оплаты труда и карьерного роста.
Отсутствие политики противодействия харассменту.
Недооценка роли человеческого фактора при проектировании систем управления.
Психологическое подавление сотрудника в момент кибератаки.
Использование данных из соцсетей для персонализации фишинговой атаки.
Целенаправленная компрометация репутации специалиста по ИБ.
Манипуляция общественным мнением через СМИ для давления на руководство.
Подкуп или психологическое воздействие на сотрудника кадровой службы.
Создание атмосферы вседозволенности среди топ-менеджмента.
Кража базы сейсмических данных 2D/3D
Компрометация систем интерпретации геоданных (Petrel и др.)
Хищение данных геофизических исследований скважин (ГИС) и керна
Кража цифровых геологических и гидродинамических моделей месторождений
Несанкционированный доступ к информации о перспективных лицензионных участках
Кража "рецептуры" и технологических режимов из систем MES на НПЗ
Перехват данных с измерительного и исследовательского оборудования
Кража проектной документации на модернизацию установок (FEED, Detail Design)
Компрометация систем управления R&D-проектами
Кража портфеля патентов и патентных заявок компании
Внедрение в системы САПР (CAD) для проектирования бурового и промыслового оборудования
Хищение данных о производительности скважин и применяемых методах интенсификации добычи
Кража данных о буровых растворах и реагентах
Несанкционированный доступ к данным о модернизации оборудования
Кража данных о трубопроводах и инфраструктуре
Кража базы данных с результатами инженерных изысканий и проектирования
Подмена данных в отчетах по запасам для ГКЗ
Саботаж системы управления буровыми установками. Авария с компрометацией данных
Компрометация облачных хранилищ, используемых для совместной работы с подрядчиками
Кража данных о планах ремонтов магистральных трубопроводов
Фишинговая атака на инженеров-технологов и геологов
Внедрение в систему управления цифровыми правами (DRM) для защищенной проектной документации
Кража бизнес-модели и стратегических планов развития активов
Несанкционированный доступ к системам видеоконференцсвязи для переговоров по M&A-сделкам
Кража базы данных с результатами аудитов промышленной безопасности
Создание "цифрового двойника-конкурента"
Фальсификация данных КИПиА. Искажение показаний датчиков
Изменение уставок технологических процессов
Отключение систем безопасности
Подделка firmware технологического оборудования
Разрыв или разгерметизация технологических трубопроводов высокого давления
Взрыв или хлопок паровоздушной смеси в резервуарах с нефтепродуктами
Выход из строя системы контроля уровня и давления в сепараторах и технологических колоннах
Отказ предохранительных клапанов и устройств аварийного сброса давления (УАСД)
Образование гидратных пробок в газосборных сетях и их разрыв при разгазировании
Коррозия стенок аппаратов, трубопроводов и резервуаров, приводящая к потере герметичности
Перегрев печей и теплообменников с последующим разложением продукта и взрывом
Ошибочные действия персонала при опрессовке оборудования и трубопроводов
Нарушение регламента пуска и останова технологической установки
Несвоевременное обнаружение и ликвидация утечек углеводородов
Недостаточная подготовка оперативного персонала к действиям по локализации аварии
Использование неисправного инструмента
Обрушение буровой вышки из-за нарушения режимов бурения, геомеханических процессов или превышения нагрузок
Внезапный отказ системы электроснабжения (блэкаут), приводящий к остановке технологических процессов и систем безопасности.
Разрушение турбины или турбодетандера с разлетом осколков.
Системная ошибка в АСУ ТП
Физический и моральный износ основных производственных фондов
Целенаправленное подрывное проникновение группировкой с целью физического разрушения серверных, диспетчерских и коммуникационных центров с целью остановки технологического процесса.
Умышленная атака на входные узлы электропитания и распределительные щиты, направленная на длительное отключение питания серверов и систем управления.
Захват персонала и удержание операторов/администрации с целью получения физического доступа к терминалам, раскрытия паролей и принуждения к выполнению команд, нарушающих работу систем.
Установка взрывных устройств в непосредственной близости от серверных помещений, центров управления и каналов связи с целью физического уничтожения оборудования.
Организованное проникновение с применением тяжелого оборудования для демонтажа и вывоза критических узлов инфраструктуры (стойки, СХД, контроллеры) с целью саботажа и продажи на чёрном рынке.
Нападение на транспортные маршруты перемещения резервных носителей и оборудования с целью похищения, изменения содержимого или уничтожения резервных копий.
Умышленное заражение физических носителей и оборудования на этапе поставки или ввоза на объект (включая деятельность инсайдеров на стороне поставщика).
Атаки на телекоммуникационные магистрали, включая перерезание подводных или наземных линий связи, с целью разрыва каналов передачи данных и управления.
Организация фальшивых служб или мероприятий (внешние рабочие бригады, демонстрации) для отвлечения охраны и обеспечения доступа к техническим помещениям.
Подрыв или повреждение объектов связи (РРЛ-станций, вышек, ретрансляторов) террористическими средствами для длительного вывода из строя каналов управления и мониторинга.
Использование инсайдеров, завербованных террористами, для получения доступа к ключевым системам и последующего физического вмешательства в работу оборудования.
Скоординированная атака на несколько объектов одновременно (серверные, диспетчерские, коммуникационные узлы) для создания эффекта распределённого отказа.
Проникновение и физическая манипуляция с системами аварийного отключения и переключения (например, ОПС и шлюзы), приводящая к неконтролируемым сценариям остановки оборудования.
Нападение на центры хранения данных в районах с ограниченной охраной (удалённые площадки, деградированные филиалы) с целью физической компрометации инфраструктуры.
Использование самодельных электронных помех или глушилок, размещённых вблизи радио- и телеком-узлов, вызывающее длительную потерю связи между объектами и центром управления.
Организация диверсий против транспортных средств, перевозящих критическое оборудование или носители, с целью уничтожения или хищения.
Физическое внедрение в коммуникационные шкафы и кроссы с заменой патч-кордов и направлением трафика через подставные узлы под контролем террористов.
Подготовка и применение устройств скрытого доступа (ложные вентиляционные решётки, фальшполы), позволяющих тайно проникнуть в помещения с оборудованием.
Атака посредством подмены поставщика услуг технического обслуживания с целью установки контролируемого оборудования или ПО во время плановых работ.
Выведение из строя систем видеонаблюдения и охранной сигнализации путём уничтожения камер, блоков питания и кабелей для обеспечения последующих скрытых действий.
Организация ложных тревог и фальсифицированных инцидентов для дезорганизации работы охраны и создания возможностей для физического вмешательства в ИТ-инфраструктуру.
Атаки на опорные точки бесперебойного электроснабжения (ИБП, дизель-генераторы) с целью их вывода из строя перед основной физической атакой на серверы.
Развертывание и эксплуатация незаконных ретрансляторов и узлов связи рядом с объектом для перехвата и подмены трафика в физической канализации.
Физическое повреждение систем контроля доступа (СКУД), включая выведение из строя турникетов, ридеров и электрозамков, для дальнейшего свободного прохода злоумышленников.
Использование сменной тактики (ночные рейды, инсценированные аварии) для получения доступа к удалённым объектам и их вычислительной инфраструктуре без немедленного обнаружения.
Применение скрытых устройств для физического вмешательства в оборудование (малые механические устройства, дистанционно активируемые кейсы) для повреждения или изменения настроек.
Организация нападения с целью захвата и изменения логистики резервных каналов (перехват, подмена маршрутов), что приведёт к затруднённому восстановлению систем после инцидента.
Использование социальной инженерии на физическом уровне (обман охранников, персонала, подкуп) для получения прав доступа к помещениям с вычислительным оборудованием.
Создание и эксплуатация подставных компаний и сервисных подрядчиков, которые получают доступ к оборудованию под предлогом обслуживания и выполняют скрытые действия в интересах террористов.
Скоординированные атаки на внешние сервисы и логистику (например, повреждение поставщиков резервных частей) с целью создать дефицит компонентов для восстановления инфраструктуры.
Подрыв дистанционного объекта (например, РТП, ретранслятора) с целью вызвать каскадный эффект на сети передачи данных и управления производством.
Атака на персонал служб ИТ и эксплуатации путем угроз и шантажа с целью заставить раскрыть физические ключи доступа или инструкции по обходу средств защиты.
Физическое повреждение датчиков контроля выбросов (СО, SOx, NOx) или систем отбора проб.
Кибератака на систему управления факельной установкой, приводящая к несанкционированному сбросу и сжиганию больших объемов ПНГ.
Несанкционированное изменение уставок в АСУ ТП очистных сооружений, приводящее к сбросу неочищенных стоков.
Вывод из строя серверов, обрабатывающих данные экологического мониторинга, путем физического доступа.
Утечка данных о реальных объемах загрязняющих веществ перед плановой проверкой надзорных органов.
Подмена программного обеспечения на контроллерах систем ППД (поддержания пластового давления), ведущая к разрыву трубопроводов.
Саботаж системы оборотного водоснабжения, вызывающий перерасход свежей воды и сброс теплых вод.
Несанкционированное отключение системы сбора и утилизации паров бензина (УПВ) на нефтебазах.
Физическое повреждение кабелей связи, соединяющих датчики на периферийных кустах скважин с центром контроля.
Установка вредоносного ПО на АРМ эколога, шифрующего данные и парализующего подготовку отчетности.
Кража или подмена проб окружающей среды (воды, почвы), отобранных для анализа, с целью сокрытия загрязнения.
Несанкционированный доступ к системам управления задвижками аварийных сбросов в водные объекты.
Целенаправленное повреждение системы вентиляции на установке сероочистки, ведущее к выбросу сероводорода.
Модификация алгоритмов работы системы диагностики трубопроводов (УЗД, СПВ), приводящая к несвоевременному обнаружению коррозии и утечек.
Перехват данных с беспилотных летательных аппаратов (БПЛА), используемых для экологического мониторинга территорий.
Физическое воздействие на резервуарные парки с целью нарушения герметичности и утечки нефтепродуктов.
Несанкционированное изменение конфигурации системы управления энергобалансом, ведущее к повышенному расходу топлива на факелах.
Блокирование работы системы оповещения о превышении ПДК вредных веществ в санитарно-защитной зоне.
Неправомерные действия подрядчика по ремонту, приводящие к нарушению герметизации шламонакопителей.
Уничтожение или хищение резервных копий данных экологического аудита и проектной документации.
Физическая атака на главный распределительный щит (ГРЩ) объекта, приводящая к полному обесточиванию.
Несанкционированное изменение программных уставок релейной защиты и автоматики (РЗА) на подстанциях.
Кибератака на систему АСДУ, приводящая к ложным командам на отключение ключевых фидеров.
Кража силовых кабелей и критических компонентов с распределительных устройств (РУ).
Диверсия на объектах собственной генерации (ГТУ, ГПЭ), выводящая их из строя на длительный срок.
Несанкционированное подключение к системе телемеханики для дистанционного отключения энергооборудования.
Подмена или повреждение устройств АСТУЭ/АИИС КУЭ для искажения данных коммерческого учета.
Вывод из строя систем ИБП и ДГУ серверных помещений и ЦОД путем физического повреждения или саботажа.
Целенаправленная перегрузка электросети объекта путем несанкционированного включения мощного оборудования.
Утечка данных о схемах и режимах энергоснабжения критических объектов для планирования атак.
Несанкционированное вмешательство в систему управления мощностью собственных генерерующих установок.
Физическое повреждение волоконно-оптических линий связи (ВОЛС) систем телемеханики и РЗА.
Установка программ-шифровальщиков на серверы систем управления энергохозяйством.
Манипуляция данными прогноза энергопотребления для создания дефицита мощности и веерных отключений.
Несанкционированный доступ к системе мониторинга состояния основного электрооборудования (трансформаторов, выключателей).
Кража или подмена журналов и баз данных оперативно-диспетчерской службы (ОДС).
Создание помех в каналах радиосвязи диспетчерской службы и ремонтных бригад.
Несанкционированное изменение графиков ремонтов энергооборудования, ведущее к его работе в нештатном режиме.
Физическая блокировка доступа персонала к распределительным устройствам и щитам управления.
Использование инсайдера в энергослужбе для преднамеренного нарушения режимов энергоснабжения.
`;

function normalizeText(value) {
  return (value || "")
    .toString()
    .toLowerCase()
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();
}

const THREAT_TAGS = THREAT_TEXT.split("\n").map((line) => line.trim()).filter(Boolean);
const THREAT_LOOKUP = THREAT_TAGS.map((phrase) =>
  normalizeText(phrase)
    .split(/\s+/)
    .filter(Boolean)
    .slice(0, 4)
);

let state = {
  items: [],
  filteredAll: [],
  filtered: [],
  category: "Все",
  period: "1y",
  search: "",
  generatedAt: "",
  sources: [],
};

function normalizeSlug(value) {
  return (
    normalizeText(value)
      .replace(/[^a-z0-9-]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "") || "all"
  );
}

function classifyCategories(blob) {
  const hits = [];
  Object.entries(CATEGORY_KEYWORDS).forEach(([name, words]) => {
    if (words.some((hint) => blob.includes(hint))) hits.push(name);
  });
  if (!hits.length) hits.push("Инфобез");
  return Array.from(new Set(hits));
}

function isEnergySource(source) {
  const src = normalizeText(source);
  return (
    src.includes("oilprice") ||
    src.includes("reuters") ||
    src.includes("energy") ||
    src.includes("bloomberg") ||
    src.includes("газета") ||
    src.includes("ведомости") ||
    src.includes("коммерсант") ||
    src.includes("рбк")
  );
}

function isOilGas(blob, source) {
  if ([...OIL_GAS_TERMS, ...ENERGY_TERMS].some((hint) => blob.includes(hint))) return true;
  return isEnergySource(source);
}

function findThreatMatches(blob) {
  const matches = [];
  THREAT_LOOKUP.forEach((tokens, idx) => {
    if (!tokens.length) return;
    if (tokens.every((token) => blob.includes(token))) {
      matches.push(THREAT_TAGS[idx]);
    }
  });
  return matches.slice(0, 8);
}

function hydrateItem(item) {
  const blob = normalizeText([item.title, item.summary].join(" "));
  if (!isOilGas(blob, item.source || "")) return null;
  return {
    ...item,
    published: item.published || "",
    categories: classifyCategories(blob),
    threatMatches: findThreatMatches(blob),
  };
}

async function loadData() {
  try {
    const res = await fetch("./data/news.json", { cache: "no-store" });
    const data = await res.json();
    state.items = (data.items || []).map(hydrateItem).filter(Boolean);
    state.generatedAt = data.generated_at;
    state.sources = data.sources || [];
    applyFilters();
  } catch (err) {
    console.error(err);
    document.getElementById("feed").innerHTML =
      '<div class="card"><p>Не удалось загрузить данные. Проверьте, что <code>data/news.json</code> создан.</p></div>';
  }
}

function applyFilters() {
  const now = Date.now();
  const periodMs = PERIODS[state.period]?.ms;
  const cutoff = periodMs ? now - periodMs : null;
  const search = normalizeText(state.search);

  let items = state.items.map((item) => ({ ...item }));

  if (state.category !== "Все") {
    items = items.filter((item) => (item.categories || []).includes(state.category));
  }

  if (cutoff) {
    items = items.filter((item) => {
      if (!item.published) return false;
      const d = new Date(item.published);
      return d.getTime() >= cutoff;
    });
  }

  if (search) {
    items = items.filter((item) => {
      const categories = (item.categories || []).join(" ");
      const threats = (item.threatMatches || []).join(" ");
      const blob = normalizeText([item.title, item.summary, item.source, categories, threats].join(" "));
      return blob && blob.includes(search);
    });
  }

  items = items.map((item) => ({
    ...item,
    published: item.published || "",
  }));

  items.sort((a, b) => new Date(b.published) - new Date(a.published));

  state.filteredAll = items;
  state.filtered = items.slice(0, MAX_FEED);
  renderStats();
  renderFeed();
}

function renderStats() {
  const nowTs = Date.now();
  const freshCount = state.items.filter((item) => {
    if (!item.published) return false;
    const d = new Date(item.published);
    return nowTs - d.getTime() <= 7 * 24 * 60 * 60 * 1000;
  }).length;

  document.getElementById("stat-new").textContent = freshCount;
  document.getElementById("stat-total").textContent = state.filteredAll.length;
  document.getElementById("stat-sources").textContent = state.sources.length;

  const gen = state.generatedAt
    ? `Обновлено: ${new Date(state.generatedAt).toLocaleString("ru-RU")}`
    : "—";
  const periodLabel = PERIODS[state.period]?.label || "—";
  document.getElementById("stat-generated").textContent = `${periodLabel} · ${gen}`;
}

function renderCategories() {
  const container = document.getElementById("category-chips");
  container.innerHTML = "";
  CATEGORIES.forEach((name) => {
    const el = document.createElement("button");
    el.className = `chip ${state.category === name ? "active" : ""}`;
    el.textContent = name;
    el.onclick = () => {
      state.category = name;
      applyFilters();
      renderCategories();
    };
    container.appendChild(el);
  });
}

function renderPeriodOptions() {
  const select = document.getElementById("period");
  select.innerHTML = "";
  Object.entries(PERIODS).forEach(([value, meta]) => {
    const option = document.createElement("option");
    option.value = value;
    option.textContent = meta.label;
    if (state.period === value) option.selected = true;
    select.appendChild(option);
  });
}

function renderFeed() {
  const feed = document.getElementById("feed");
  if (!state.filtered.length) {
    feed.innerHTML = '<div class="card"><p>Нет кейсов по этим фильтрам. Попробуйте другой период или категорию.</p></div>';
    return;
  }

  feed.innerHTML = state.filtered
    .map((item) => {
      const date = item.published ? new Date(item.published).toLocaleString("ru-RU") : "—";
      const categories = (item.categories || []).map((c) => `<span class="pill orange">${c}</span>`).join("");
      const hint = (item.categories || [])
        .map((c) => CATEGORY_HINT[c] || CATEGORY_HINT["Общее"])
        .filter(Boolean)
        .join(" · ") || CATEGORY_HINT["Общее"];
      const threats = (item.threatMatches || [])
        .slice(0, 4)
        .map((tag) => `<span class="pill muted">${tag}</span>`)
        .join("");
      const threatLine = threats
        ? `<div class="threat-tags"><span class="pill purple">Совпадения угроз</span>${threats}</div>`
        : "";
      return `
        <article class="card">
          <div class="card-header">
            <h3 class="card-title">${item.title}</h3>
            <div class="card-meta">
              <span class="pill cyan">${item.source}</span>
              <span>${date}</span>
            </div>
          </div>
          <p>${item.summary || "Нет описания"}</p>
          <p class="threat-label">Угроза: ${hint}</p>
          ${threatLine}
          <div class="card-footer">
            ${categories}
            <a class="pill" style="text-decoration:none" href="${item.link}" target="_blank" rel="noopener">Читать</a>
          </div>
        </article>
      `;
    })
    .join("");
}

const THREAT_LIBRARY = [
  {
    title: "Терроризм",
    items: [
      "Диверсии на узлах связи и электропитания",
      "Захват персонала для доступа к терминалам",
      "Скоординированные атаки на несколько площадок",
    ],
  },
  {
    title: "Физическая",
    items: [
      "Проникновение в серверные и кроссовые",
      "Кража или подмена оборудования",
      "Обход СКУД и работа без допуска",
    ],
  },
  {
    title: "Экология",
    items: [
      "Разгерметизация и утечки ЛВЖ/ГГ",
      "Саботаж систем экомониторинга",
      "Подмена проб и отчётности перед проверкой",
    ],
  },
  {
    title: "Энергетика",
    items: [
      "Атаки на РЗА и телемеханику подстанций",
      "Повреждение ВОЛС и силовых кабелей",
      "Саботаж ИБП/ДГУ и перегрузка сети",
    ],
  },
  {
    title: "Инфобез",
    items: [
      "Кибератаки на АСУ ТП и ERP",
      "Шифровальщики и утечки данных",
      "Фишинг под руководителей и поставщиков",
    ],
  },
  {
    title: "Психология",
    items: [
      "Шантаж и давление на операторов",
      "Выгорание и усталость сменных бригад",
      "Дезинформация и провокации забастовок",
    ],
  },
  {
    title: "Техногенная",
    items: [
      "Отказы арматуры и датчиков",
      "Ошибки при пусках/остановах",
      "Коррозия и разрушение трубопроводов",
    ],
  },
  {
    title: "Пожарная",
    items: [
      "Возгорания при огневых работах",
      "Неисправность АПС/АУПТ и молниезащиты",
      "Отсутствие путей эвакуации",
    ],
  },
  {
    title: "Экономическая",
    items: [
      "Манипуляции расчётами и отчетностью",
      "Срывы поставок через логистику",
      "Блокировка платежей и биржевые атаки",
    ],
  },
  {
    title: "Интеллектуальная",
    items: [
      "Кража геоданных и моделей месторождений",
      "Доступ к R&D и проектной документации",
      "Создание цифровых двойников-конкурентов",
    ],
  },
];

function renderThreatMatrix() {
  const root = document.getElementById("matrix");
  root.innerHTML = THREAT_LIBRARY.map(
    (block) => `
      <div class="matrix-card">
        <h3>${block.title}</h3>
        <ul>
          ${block.items.map((i) => `<li>${i}</li>`).join("")}
        </ul>
      </div>
    `
  ).join("");
}

function downloadCsv() {
  alert("CSV выключен. Используйте Excel.");
}

function colLabel(idx) {
  let n = idx + 1;
  let label = "";
  while (n > 0) {
    n -= 1;
    label = String.fromCharCode(65 + (n % 26)) + label;
    n = Math.floor(n / 26);
  }
  return label;
}

function buildSheetXml(rows) {
  const esc = (v) =>
    (v || "")
      .toString()
      .replace(/\r?\n+/g, " ")
      .trim()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

  const rowXml = rows
    .map((vals, rIdx) => {
      const cells = vals
        .map((v, cIdx) => {
          const safe = /^[=+\-@]/.test(v || "") ? `'${v}` : v;
          return `<c r="${colLabel(cIdx)}${rIdx + 1}" t="inlineStr"><is><t>${esc(safe)}</t></is></c>`;
        })
        .join("");
      return `<row r="${rIdx + 1}">${cells}</row>`;
    })
    .join("");

  return (
    `<?xml version="1.0" encoding="UTF-8"?>` +
    `<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">` +
    `<sheetData>${rowXml}</sheetData>` +
    `</worksheet>`
  );
}

// Minimal ZIP builder (store method, no compression) for XLSX packaging.
function makeZip(files) {
  const encoder = new TextEncoder();
  const toBytes = (input) => (input instanceof Uint8Array ? input : encoder.encode(input));
  const crcTable = (() => {
    const table = [];
    for (let i = 0; i < 256; i++) {
      let c = i;
      for (let j = 0; j < 8; j++) c = c & 1 ? 0xedb88320 ^ (c >>> 1) : c >>> 1;
      table[i] = c >>> 0;
    }
    return table;
  })();
  const crc32 = (buf) => {
    let crc = 0 ^ -1;
    for (let i = 0; i < buf.length; i++) crc = (crc >>> 8) ^ crcTable[(crc ^ buf[i]) & 0xff];
    return (crc ^ -1) >>> 0;
  };
  const le32 = (n) => {
    const b = new Uint8Array(4);
    const dv = new DataView(b.buffer);
    dv.setUint32(0, n, true);
    return b;
  };
  const le16 = (n) => {
    const b = new Uint8Array(2);
    const dv = new DataView(b.buffer);
    dv.setUint16(0, n, true);
    return b;
  };

  let offset = 0;
  const fileHeaders = [];
  const centralRecords = [];

  files.forEach(({ path, content }) => {
    const data = toBytes(content);
    const nameBytes = encoder.encode(path);
    const crc = crc32(data);
    const local = [
      encoder.encode("PK\x03\x04"),
      le16(20),
      le16(0),
      le16(0),
      le16(0),
      le16(0),
      le32(crc),
      le32(data.length),
      le32(data.length),
      le16(nameBytes.length),
      le16(0),
      nameBytes,
      data,
    ];
    const localSize = local.reduce((s, chunk) => s + chunk.length, 0);
    fileHeaders.push(local);

    const central = [
      encoder.encode("PK\x01\x02"),
      le16(20),
      le16(20),
      le16(0),
      le16(0),
      le16(0),
      le16(0),
      le32(crc),
      le32(data.length),
      le32(data.length),
      le16(nameBytes.length),
      le16(0),
      le16(0),
      le16(0),
      le16(0),
      le32(0),
      le32(offset),
      nameBytes,
    ];
    const centralSize = central.reduce((s, chunk) => s + chunk.length, 0);
    centralRecords.push({ bytes: central, size: centralSize });
    offset += localSize;
  });

  const centralStart = offset;
  const centralBytes = centralRecords.flatMap((r) => r.bytes);
  const centralLength = centralBytes.reduce((s, c) => s + c.length, 0);

  const end = [
    encoder.encode("PK\x05\x06"),
    le16(0),
    le16(0),
    le16(files.length),
    le16(files.length),
    le32(centralLength),
    le32(centralStart),
    le16(0),
  ];

  const all = [...fileHeaders.flat(), ...centralBytes, ...end];
  const total = all.reduce((s, c) => s + c.length, 0);
  const out = new Uint8Array(total);
  let ptr = 0;
  all.forEach((chunk) => {
    out.set(chunk, ptr);
    ptr += chunk.length;
  });
  return out;
}

function downloadExcel() {
  if (!state.filteredAll.length) {
    alert("Нет данных для выгрузки по текущим фильтрам");
    return;
  }

  const header = ["title", "source", "published", "link", "categories", "threat_matches", "summary"];
  const rows = state.filteredAll.map((item) => [
    item.title || "",
    item.source || "",
    item.published || "",
    item.link || "",
    (item.categories || []).join("; "),
    (item.threatMatches || []).join(" | "),
    item.summary || "",
  ]);
  const sheet = buildSheetXml([header, ...rows]);

  const files = [
    {
      path: "[Content_Types].xml",
      content:
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">` +
        `<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>` +
        `<Default Extension="xml" ContentType="application/xml"/>` +
        `<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>` +
        `<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>` +
        `</Types>`,
    },
    {
      path: "_rels/.rels",
      content:
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">` +
        `<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>` +
        `</Relationships>`,
    },
    {
      path: "xl/_rels/workbook.xml.rels",
      content:
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">` +
        `<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>` +
        `</Relationships>`,
    },
    {
      path: "xl/workbook.xml",
      content:
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">` +
        `<sheets><sheet name="ThreatFeed" sheetId="1" r:id="rId1"/></sheets>` +
        `</workbook>`,
    },
    {
      path: "xl/worksheets/sheet1.xml",
      content: sheet,
    },
  ];

  const zipBytes = makeZip(files);
  const blob = new Blob([zipBytes], {
    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const suffix = state.category === "Все" ? "all" : normalizeSlug(state.category);
  a.href = url;
  a.download = `threat-feed-${suffix}.xlsx`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

function bindControls() {
  document.getElementById("search").addEventListener("input", (e) => {
    state.search = e.target.value;
    applyFilters();
  });

  document.getElementById("period").addEventListener("change", (e) => {
    state.period = e.target.value;
    applyFilters();
  });

  document.getElementById("refresh").addEventListener("click", () => loadData());
  document.getElementById("exportExcel").addEventListener("click", downloadExcel);
}

renderPeriodOptions();
renderCategories();
renderThreatMatrix();
bindControls();
loadData();
